# Default values for the helm chart.
# This is a YAML-formatted file.
# Declare variables to be passed into your templates.
#
# Note about Namespace
# --------------------
# It is deliberately left out here and using the helm -n or --namespace flag you can deploy your resources to the same
# namespace as the release. If you leave it out, your resources will be deployed to the default namespace.
# Also, not that the namespace you are deploying to should already exist otherwise the helm command will fail.
# You can always specify a different namespace for a resource by setting it directly in it's yaml file or
# making it configurable by defining it in this file.

###########
# Deployment and Service
###########
replicaCount: 1
maxUnavailable: 0

image:
  repository: traceableai-docker.jfrog.io/hypertrace/hypertrace-data-config-service
  pullPolicy: IfNotPresent
  tagOverride: "test"

imagePullSecrets: {}

containerPort: 9012
containerAdminPort: 9013

service:
  name: hypertrace-data-config-service
  type: ClusterIP
  port: 9012

nodeLabels: {}

javaOpts: "-XX:InitialRAMPercentage=50.0 -XX:MaxRAMPercentage=75.0"

livenessProbe:
  initialDelaySeconds: 10
  periodSeconds: 5

readinessProbe:
  initialDelaySeconds: 2
  periodSeconds: 5

resources:
  # We usually recommend not to specify default resources and to leave this as a conscious
  # choice for the user. This also increases chances charts run on environments with little
  # resources, such as Minikube. If you do want to specify resources, uncomment the following
  # lines, adjust them as necessary, and remove the curly braces after 'resources:'.
  requests:
    cpu: 0.1
    memory: 1024Mi
  limits:
    cpu: 1
    memory: 1024Mi

deploymentLabels:
  app: hypertrace-data-config-service

podLabels:
  app: hypertrace-data-config-service

podAnnotations: {}

# The Deployment Selector match labels are different from the pod labels. Note that they should be a subset of the pod
# labels. You append new labels to them but cannot remove labels. If you remove or modify the labels you will need to
# delete the existing deployment bearing the same name and then redeploy. This is the reason why they are separated from
# the pod labels. You can add and remove pod labels without having an effect on the deployment.
# Also, please use "apiVersion: apps/v1" instead of the deprecated "apiVersion: extensions/v1beta1" for the deployment
# apiVersion in the yaml file.
deploymentSelectorMatchLabels:
  app: hypertrace-data-config-service

serviceSelectorLabels:
  app: hypertrace-data-config-service

###########
# Config Maps
###########
attributeServiceConfig:
  name: attribute-service-config
  dataStoreType: "mongo"
  mongo:
    host: mongo
    url: ""
  postgres:
    host: postgres
    port: 5432
    url: ""

configServiceConfig:
  name: config-service-config
  dataStoreType: "mongo"
  mongo:
    host: mongo
    url: ""

entityServiceConfig:
  name: entity-service-config
  dataStoreType: "mongo"
  mongo:
    host: mongo
    url: ""
  postgres:
    host: postgres
    port: 5432
    url: ""

hypertraceDataConfigServiceConfig:
  name: hypertrace-data-config-service-config
  data:
    application.conf: |-
      service.port = 9012
      service.admin.port = 9013

logConfig:
  name: hypertrace-data-config-service-log-config
  monitorInterval: 30
  rootLogger:
    level: INFO
  appender:
    rolling:
      enabled: false

config-bootstrapper:
  job:
    prefix: attribute-entity
  configurationCommands:
    saas_entity: |-
      version = 2
      name = saas_entity
      commands = [
        {
          upgrade : [
            {
              type : EntityType,
              action : ADD,
              data : {
                entityTypes = [
                  {
                      "attributeType" : [
                          {
                              "name" : "EXTERNAL_ID",
                              "valueKind" : "TYPE_STRING",
                              "identifyingAttribute" : true
                          },
                          {
                              "name" : "NAMESPACE_NAME",
                              "valueKind" : "TYPE_STRING",
                              "materialized" : true
                          },
                          {
                              "name" : "CLUSTER_NAME",
                              "valueKind" : "TYPE_STRING",
                              "materialized" : true
                          }
                      ],
                      "name" : "K8S_STATEFUL_SET"
                  },
                  {
                      "attributeType" : [
                          {
                              "name" : "EXTERNAL_ID",
                              "valueKind" : "TYPE_STRING",
                              "identifyingAttribute" : true
                          },
                          {
                              "name" : "CLUSTER_NAME",
                              "valueKind" : "TYPE_STRING",
                              "materialized" : true
                          },
                          {
                              "name" : "selector",
                              "valueKind" : "TYPE_STRING"
                          },
                          {
                              "name" : "NAMESPACE_NAME",
                              "valueKind" : "TYPE_STRING",
                              "materialized" : true
                          }
                      ],
                      "name" : "K8S_SERVICE"
                  },
                  {
                      "attributeType" : [
                          {
                              "name" : "EXTERNAL_ID",
                              "valueKind" : "TYPE_STRING",
                              "identifyingAttribute" : true
                          },
                          {
                              "name" : "NAMESPACE_NAME",
                              "valueKind" : "TYPE_STRING",
                              "materialized" : true
                          },
                          {
                              "name" : "CLUSTER_NAME",
                              "valueKind" : "TYPE_STRING",
                              "materialized" : true
                          }
                      ],
                      "name" : "K8S_REPLICA_SET"
                  },
                  {
                      "attributeType" : [
                          {
                              "name" : "EXTERNAL_ID",
                              "valueKind" : "TYPE_STRING",
                              "identifyingAttribute" : true
                          },
                          {
                              "name" : "NAMESPACE_NAME",
                              "valueKind" : "TYPE_STRING",
                              "materialized" : true
                          },
                          {
                              "name" : "CLUSTER_NAME",
                              "valueKind" : "TYPE_STRING",
                              "materialized" : true
                          },
                          {
                              "name" : "REPLICASET_NAME",
                              "valueKind" : "TYPE_STRING"
                          },
                          {
                              "name" : "REPLICASET_ID",
                              "valueKind" : "TYPE_STRING"
                          }
                      ],
                      "name" : "K8S_POD"
                  },
                  {
                      "attributeType" : [
                          {
                              "name" : "EXTERNAL_ID",
                              "valueKind" : "TYPE_STRING",
                              "identifyingAttribute" : true
                          },
                          {
                              "name" : "CLUSTER_NAME",
                              "valueKind" : "TYPE_STRING",
                              "materialized" : true
                          }
                      ],
                      "name" : "K8S_NODE"
                  },
                  {
                      "attributeType" : [
                          {
                              "name" : "EXTERNAL_ID",
                              "valueKind" : "TYPE_STRING",
                              "identifyingAttribute" : true
                          },
                          {
                              "name" : "CLUSTER_NAME",
                              "valueKind" : "TYPE_STRING",
                              "materialized" : true
                          }
                      ],
                      "name" : "K8S_NAMESPACE"
                  },
                  {
                      "attributeType" : [
                          {
                              "name" : "EXTERNAL_ID",
                              "valueKind" : "TYPE_STRING",
                              "identifyingAttribute" : true
                          },
                          {
                              "name" : "NAMESPACE_NAME",
                              "valueKind" : "TYPE_STRING",
                              "materialized" : true
                          },
                          {
                              "name" : "CLUSTER_NAME",
                              "valueKind" : "TYPE_STRING",
                              "materialized" : true
                          }
                      ],
                      "name" : "K8S_JOB"
                  },
                  {
                      "attributeType" : [
                          {
                              "name" : "EXTERNAL_ID",
                              "valueKind" : "TYPE_STRING",
                              "identifyingAttribute" : true
                          }
                      ],
                      "name" : "K8S_ENDPOINT"
                  },
                  {
                      "attributeType" : [
                          {
                              "name" : "EXTERNAL_ID",
                              "valueKind" : "TYPE_STRING",
                              "identifyingAttribute" : true
                          },
                          {
                              "name" : "NAMESPACE_NAME",
                              "valueKind" : "TYPE_STRING",
                              "materialized" : true
                          },
                          {
                              "name" : "CLUSTER_NAME",
                              "valueKind" : "TYPE_STRING",
                              "materialized" : true
                          }
                      ],
                      "name" : "K8S_DEPLOYMENT"
                  },
                  {
                      "attributeType" : [
                          {
                              "name" : "EXTERNAL_ID",
                              "valueKind" : "TYPE_STRING",
                              "identifyingAttribute" : true
                          },
                          {
                              "name" : "CLUSTER_NAME",
                              "valueKind" : "TYPE_STRING",
                              "materialized" : true
                          },
                          {
                              "name" : "NAMESPACE_NAME",
                              "valueKind" : "TYPE_STRING",
                              "materialized" : true
                          }
                      ],
                      "name" : "K8S_DAEMON_SET"
                  },
                  {
                      "attributeType" : [
                          {
                              "name" : "EXTERNAL_ID",
                              "valueKind" : "TYPE_STRING",
                              "identifyingAttribute" : true
                          },
                          {
                              "name" : "NAMESPACE_NAME",
                              "valueKind" : "TYPE_STRING",
                              "materialized" : true
                          },
                          {
                              "name" : "CLUSTER_NAME",
                              "valueKind" : "TYPE_STRING",
                              "materialized" : true
                          }
                      ],
                      "name" : "K8S_CRONJOB"
                  },
                  {
                      "attributeType" : [
                          {
                              "name" : "EXTERNAL_ID",
                              "valueKind" : "TYPE_STRING",
                              "identifyingAttribute" : true
                          }
                      ],
                      "name" : "K8S_CONFIG_MAP"
                  },
                  {
                      "attributeType" : [
                          {
                              "name" : "EXTERNAL_ID",
                              "valueKind" : "TYPE_STRING",
                              "identifyingAttribute" : true
                          }
                      ],
                      "name" : "K8S_CLUSTER"
                  },
                  {
                      "attributeType" : [
                          {
                              "name" : "EXTERNAL_ID",
                              "valueKind" : "TYPE_STRING",
                              "identifyingAttribute" : true
                          },
                          {
                              "name" : "NAMESPACE_NAME",
                              "valueKind" : "TYPE_STRING",
                              "materialized" : true
                          },
                          {
                              "name" : "IMAGE",
                              "valueKind" : "TYPE_STRING",
                              "materialized" : true
                          },
                          {
                              "name" : "POD_NAME",
                              "valueKind" : "TYPE_STRING"
                          },
                          {
                              "name" : "CLUSTER_NAME",
                              "valueKind" : "TYPE_STRING",
                              "materialized" : true
                          }
                      ],
                      "name" : "DOCKER_CONTAINER"
                  },
                  {
                      "attributeType" : [
                          {
                              "name" : "actor_id",
                              "valueKind" : "TYPE_STRING",
                              "identifyingAttribute" : true
                          }
                      ],
                      "name" : "ACTOR"
                  }
                ]
              }
            }
          ]
          rollback : [
            {
              type : EntityType,
              action : DELETE,
              data : {
                filter = {}
              }
            }
          ]
        },
        {
          upgrade : [
            {
              type : EntityRelationshipType,
              action : ADD,
              data : {
                entityRelationshipTypes = [
                  {
                      "fromEntityType" : "K8S_STATEFUL_SET",
                      "multiplicityKind" : "ONE_TO_MANY",
                      "name" : "STATEFULSET_POD",
                      "toEntityType" : "K8S_POD"
                  },
                  {
                      "fromEntityType" : "SERVICE",
                      "multiplicityKind" : "ONE_TO_MANY",
                      "name" : "SERVICE_DEPLOYMENT",
                      "toEntityType" : "K8S_DEPLOYMENT"
                  },
                  {
                      "fromEntityType" : "K8S_REPLICA_SET",
                      "multiplicityKind" : "ONE_TO_MANY",
                      "name" : "REPLICASET_POD",
                      "toEntityType" : "K8S_POD"
                  },
                  {
                      "fromEntityType" : "K8S_POD",
                      "multiplicityKind" : "ONE_TO_MANY",
                      "name" : "POD_CONTAINER",
                      "toEntityType" : "DOCKER_CONTAINER"
                  },
                  {
                      "fromEntityType" : "K8S_NAMESPACE",
                      "multiplicityKind" : "ONE_TO_MANY",
                      "name" : "NAMESPACE_STATEFULSET",
                      "toEntityType" : "K8S_STATEFUL_SET"
                  },
                  {
                      "fromEntityType" : "K8S_NAMESPACE",
                      "multiplicityKind" : "ONE_TO_MANY",
                      "name" : "NAMESPACE_K8S_SERVICE",
                      "toEntityType" : "K8S_SERVICE"
                  },
                  {
                      "fromEntityType" : "K8S_NAMESPACE",
                      "multiplicityKind" : "ONE_TO_MANY",
                      "name" : "NAMESPACE_JOB",
                      "toEntityType" : "K8S_JOB"
                  },
                  {
                      "fromEntityType" : "K8S_NAMESPACE",
                      "multiplicityKind" : "ONE_TO_MANY",
                      "name" : "NAMESPACE_DEPLOYMENT",
                      "toEntityType" : "K8S_DEPLOYMENT"
                  },
                  {
                      "fromEntityType" : "K8S_NAMESPACE",
                      "multiplicityKind" : "ONE_TO_MANY",
                      "name" : "NAMESPACE_DAEMONSET",
                      "toEntityType" : "K8S_DAEMON_SET"
                  },
                  {
                      "fromEntityType" : "K8S_NAMESPACE",
                      "multiplicityKind" : "ONE_TO_MANY",
                      "name" : "NAMESPACE_CRONJOB",
                      "toEntityType" : "K8S_CRONJOB"
                  },
                  {
                      "fromEntityType" : "K8S_NODE",
                      "multiplicityKind" : "ONE_TO_MANY",
                      "name" : "K8S_NODE_POD",
                      "toEntityType" : "K8S_POD"
                  },
                  {
                      "fromEntityType" : "K8S_DEPLOYMENT",
                      "multiplicityKind" : "ONE_TO_ONE",
                      "name" : "DEPLOYMENT_REPLICASET",
                      "toEntityType" : "K8S_REPLICA_SET"
                  },
                  {
                      "fromEntityType" : "K8S_DAEMON_SET",
                      "multiplicityKind" : "ONE_TO_MANY",
                      "name" : "DAEMONSET_POD",
                      "toEntityType" : "K8S_POD"
                  },
                  {
                      "fromEntityType" : "K8S_CLUSTER",
                      "multiplicityKind" : "ONE_TO_MANY",
                      "name" : "CLUSTER_NODE",
                      "toEntityType" : "K8S_NODE"
                  },
                  {
                      "fromEntityType" : "K8S_CLUSTER",
                      "multiplicityKind" : "ONE_TO_MANY",
                      "name" : "CLUSTER_NAMESPACE",
                      "toEntityType" : "K8S_NAMESPACE"
                  },
                  {
                      "fromEntityType" : "API",
                      "multiplicityKind" : "MANY_TO_MANY",
                      "name" : "API_POD",
                      "toEntityType" : "K8S_POD"
                  },
                  {
                    "fromEntityType" : "K8S_SERVICE",
                    "multiplicityKind" : "MANY_TO_MANY",
                    "name" : "K8S_SERVICE_K8S_DEPLOYMENT",
                    "toEntityType" : "K8S_DEPLOYMENT"
                  },
                  {
                    "fromEntityType" : "K8S_NAMESPACE",
                    "multiplicityKind" : "ONE_TO_MANY",
                    "name" : "NAMESPACE_SERVICE",
                    "toEntityType" : "SERVICE"
                  }
                ]
              }
            }
          ]
          rollback : [
            {
              type : EntityRelationshipType,
              action : DELETE,
              data : {
                filter = {}
              }
            }
          ]
        }
      ]
  entityServiceConfig:
    name: entity-service-config
    data:
      host: hypertrace-data-config-service
      port: 9012
  attributeServiceConfig:
    name: attribute-service-config
    data:
      host: hypertrace-data-config-service
      port: 9012
  dataStoreType: "mongo"
  mongoConfig:
    name: mongo-config
    data:
      host: mongo
      port: 27017
      url: ""
